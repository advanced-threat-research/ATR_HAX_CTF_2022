#include <stdio.h>
#include <stdlib.h>
#include <time.h>

//gcc -m2 --static -fstack-protector-all -o time vuln.c
char location[64];

int print_time(int i) {
	time_t now;
	time(&now);
	struct tm *local = localtime(&now);
    struct tm *target = localtime(&now);
    char input[50];

    snprintf(input, 50, "%d-%02d-%02d %02d:%02d:%02d %s", local->tm_year + 1900, 
            local->tm_mon+1, local->tm_mday, local->tm_hour, local->tm_min, local->tm_sec, location);

    strptime(input, "%F %H:%M:%S %Z", target);

	if (i == 1) {
		printf("Time is: %02d:%02d:%02d %s\n", target->tm_hour, target->tm_min, target->tm_sec, location);
	} else if (i == 2) {
		printf("Date is: %02d/%02d/%04d\n", target->tm_mon+1, target->tm_mday, target->tm_year+1900); 
	}
	return 0;
}

void get_local_tz() {
    time_t now;
    time(&now);
    struct tm *local = localtime(&now);
    strftime(location, 64, "%Z", local);
}

void get_location() {
    getchar();
    printf("The Timezone setting functionality is currently in beta and may not work\n");
    printf("What is your TZ?\n");
    if (fgets(location, sizeof(location), stdin) == NULL) {
        strcpy(location, "GMT");
    }
}

int action() {
	char buf[128];
	scanf("%s", buf);
	if (strcmp(buf, "T") == 0) {
		print_time(1);
	} else if (strcmp(buf, "D") == 0) {
		print_time(2);
    } else if (strcmp(buf, "L") == 0) {
        get_location();
        return 1;
    } else {
		printf("Invalid option: ");
		printf(buf);
		printf("\n");
        return 1;
	}
	return 0;
}


int main(void) {
    setvbuf(stdout, NULL, _IONBF, 0);
    int ret = 1;
    get_local_tz();

    while(ret) {
        printf("Welcome to the time and date server!\nPlease select from the following options.\n\tT = Show current time.\n\tD = Show current date.\n");
        ret = action();
    }
}
